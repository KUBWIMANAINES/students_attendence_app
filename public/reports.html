<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Reports - Student Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-bar"></i> Attendance System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-user-check"></i> Mark Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">
                            <i class="fas fa-chart-bar"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reports.html">
                            <i class="fas fa-file-pdf"></i> Reports
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1><i class="fas fa-file-pdf"></i> Attendance Reports</h1>
                <p class="text-muted">Generate and view detailed attendance reports</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-3">
                <label class="form-label">Student</label>
                <select class="form-select" id="studentFilter">
                    <option value="">All Students</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-primary w-100" onclick="generateReport()">
                        <i class="fas fa-search"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Summary -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Days</h6>
                        <h3 id="totalDays">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Present</h6>
                        <h3 id="totalPresent" class="text-success">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Absent</h6>
                        <h3 id="totalAbsent" class="text-danger">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Overall %</h6>
                        <h3 id="overallPercent">0%</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Attendance Details</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-success" onclick="exportCSV()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="reportTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Student</th>
                                        <th>Roll No</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="reportBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Select date range and click Generate Report</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Summary -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Monthly Summary by Student</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="summaryTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Student</th>
                                        <th>Roll No</th>
                                        <th>Present Days</th>
                                        <th>Absent Days</th>
                                        <th>Attendance %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Generate report to view summary</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize date fields
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').valueAsDate = firstDay;
            document.getElementById('endDate').valueAsDate = today;
            
            loadStudentFilter();
        });

        async function loadStudentFilter() {
            try {
                const res = await fetch('/api/students');
                const students = await res.json();
                const select = document.getElementById('studentFilter');
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.roll_no || 'N/A'})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function generateReport() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const studentId = document.getElementById('studentFilter').value;

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }

                const res = await fetch('/api/students');
                const students = await res.json();
                let allAttendance = [];

                for (const student of students) {
                    if (studentId && student.id != studentId) continue;

                    const attendanceRes = await fetch(`/api/students/${student.id}/attendance?start=${startDate}&end=${endDate}`);
                    const attendance = await attendanceRes.json();
                    
                    attendance.forEach(record => {
                        allAttendance.push({
                            ...record,
                            name: student.name,
                            roll_no: student.roll_no
                        });
                    });
                }

                displayReportTable(allAttendance);
                displaySummary(allAttendance, students.filter(s => !studentId || s.id == studentId));
                calculateStats(allAttendance);
            } catch (err) {
                console.error(err);
            }
        }

        function displayReportTable(data) {
            const tbody = document.getElementById('reportBody');
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No attendance records found</td></tr>';
                return;
            }

            const sorted = data.sort((a, b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = sorted.map(record => `
                <tr>
                    <td><strong>${record.name}</strong></td>
                    <td>${record.roll_no || '-'}</td>
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>
                        <span class="badge ${record.status === 'present' ? 'bg-success' : 'bg-danger'}">
                            ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                        </span>
                    </td>
                    <td>${record.note || '-'}</td>
                </tr>
            `).join('');
        }

        function displaySummary(data, students) {
            const summaryBody = document.getElementById('summaryBody');
            let summaryRows = '';

            for (const student of students) {
                const studentRecords = data.filter(d => d.id === student.id);
                const present = studentRecords.filter(r => r.status === 'present').length;
                const absent = studentRecords.filter(r => r.status === 'absent').length;
                const total = present + absent;
                const percent = total > 0 ? Math.round((present / total) * 100) : 0;

                let statusBadge = '<span class="badge bg-success">Good</span>';
                if (percent < 75) statusBadge = '<span class="badge bg-danger">At Risk</span>';
                else if (percent < 85) statusBadge = '<span class="badge bg-warning">Average</span>';

                summaryRows += `
                    <tr>
                        <td><strong>${student.name}</strong></td>
                        <td>${student.roll_no || '-'}</td>
                        <td><span class="badge bg-success">${present}</span></td>
                        <td><span class="badge bg-danger">${absent}</span></td>
                        <td><strong>${percent}%</strong></td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }

            summaryBody.innerHTML = summaryRows || '<tr><td colspan="6" class="text-center text-muted">No data</td></tr>';
        }

        function calculateStats(data) {
            const present = data.filter(d => d.status === 'present').length;
            const absent = data.filter(d => d.status === 'absent').length;
            const total = present + absent;
            const percent = total > 0 ? Math.round((present / total) * 100) : 0;

            document.getElementById('totalDays').textContent = total;
            document.getElementById('totalPresent').textContent = present;
            document.getElementById('totalAbsent').textContent = absent;
            document.getElementById('overallPercent').textContent = percent + '%';
        }

        function exportCSV() {
            const table = document.getElementById('reportTable');
            let csv = [];
            
            table.querySelectorAll('tr').forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const csvRow = Array.from(cols).map(col => `"${col.textContent.trim()}"`).join(',');
                csv.push(csvRow);
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            downloadFile(blob, `attendance_report_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportPDF() {
            const element = document.getElementById('reportTable');
            const opt = {
                margin: 10,
                filename: `attendance_report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
