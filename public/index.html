<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-bar"></i> Attendance System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">
                            <i class="fas fa-user-check"></i> Mark Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">
                            <i class="fas fa-chart-bar"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports.html">
                            <i class="fas fa-file-pdf"></i> Reports
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">
                    <i class="fas fa-user-check text-success"></i> Student Attendance
                </h1>

                <!-- Add Student Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Add Student</h5>
                    </div>
                    <div class="card-body">
                        <form id="studentForm" class="row g-2">
                            <div class="col-8">
                                <input type="text" class="form-control" id="studentName" placeholder="Student Name" required>
                            </div>
                            <div class="col-4">
                                <input type="text" class="form-control" id="studentRoll" placeholder="Roll No (optional)">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Student</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Students List -->
                <div id="studentsList">
                    <!-- Students will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Attendance History</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="historyBody">
            <!-- history -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadStudents);
        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('studentName').value.trim();
            const roll_no = document.getElementById('studentRoll').value.trim();
            if (!name) return;
            await fetch('/api/students', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, roll_no })
            });
            document.getElementById('studentForm').reset();
            loadStudents();
        });

        async function loadStudents() {
            try {
                const res = await fetch('/api/students');
                const students = await res.json();
                displayStudents(students);
            } catch (err) {
                console.error(err);
            }
        }

        function displayStudents(students) {
            const container = document.getElementById('studentsList');
            if (!students.length) {
                container.innerHTML = '<div class="text-center text-muted">No students added. Add students above.</div>';
                return;
            }

            container.innerHTML = students.map(s => `
                <div class="card mb-2">
                  <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-0">${s.name} ${s.roll_no ? `<small class="text-muted">(${s.roll_no})</small>` : ''}</h6>
                      <small class="text-muted">Added: ${new Date(s.created_at).toLocaleString ? new Date(s.created_at).toLocaleString() : ''}</small>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-success me-1" onclick="mark(${s.id}, 'present')"><i class="fas fa-check"></i> Present</button>
                      <button class="btn btn-sm btn-danger me-1" onclick="mark(${s.id}, 'absent')"><i class="fas fa-times"></i> Absent</button>
                      <button class="btn btn-sm btn-outline-primary" onclick="viewHistory(${s.id}, '${escapeHtml(s.name)}')"><i class="fas fa-history"></i> History</button>
                    </div>
                  </div>
                </div>
            `).join('');
        }

        async function mark(id, status) {
            try {
                const res = await fetch(`/api/students/${id}/attendance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status }) // date defaults to today on server
                });
                if (res.ok) {
                    showAlert('Attendance recorded', 'success');
                } else {
                    const err = await res.json();
                    showAlert(err.error || 'Failed', 'danger');
                }
            } catch (err) {
                console.error(err);
                showAlert('Error recording attendance', 'danger');
            }
        }

        async function viewHistory(id, name) {
            try {
                const res = await fetch(`/api/students/${id}/attendance?start=&end=`);
                const rows = await res.json();
                const body = document.getElementById('historyBody');
                if (!rows.length) {
                    body.innerHTML = `<p>No attendance records for ${name}.</p>`;
                } else {
                    body.innerHTML = `
                      <h6>${name}</h6>
                      <table class="table table-sm">
                        <thead><tr><th>Date</th><th>Status</th><th>Note</th></tr></thead>
                        <tbody>
                          ${rows.map(r => `<tr><td>${r.date}</td><td>${r.status}</td><td>${r.note || ''}</td></tr>`).join('')}
                        </tbody>
                      </table>
                    `;
                }
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                modal.show();
            } catch (err) {
                console.error(err);
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
            setTimeout(() => alertDiv.remove(), 4000);
        }

        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        }
    </script>
</body>
</html>
