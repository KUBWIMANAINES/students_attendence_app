name: CI/CD Pipeline - Complete

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/attendance-app
  NODE_VERSION: '18'

jobs:
  # Stage 1: Code Quality & Linting
  lint:
    name: 'Code Quality & Linting'
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4
    
    - name: 'Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: 'Install Dependencies'
      run: npm ci
    
    - name: 'Run ESLint'
      run: npm run lint
    
    - name: 'Notify Slack - Lint Success'
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚úÖ Code Quality Passed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚úÖ Code Quality Passed*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: 'Notify Slack - Lint Failed'
      if: failure()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚ùå Code Quality Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ùå Code Quality Failed*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Logs:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Stage 2: Security Checks
  security:
    name: 'Security Scanning'
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4
    
    - name: 'Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: 'Install Dependencies'
      run: npm ci
    
    - name: 'Check Vulnerabilities'
      run: npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: 'Notify Slack - Security Passed'
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "üîí Security Check Passed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üîí Security Check Passed*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: 'Notify Slack - Security Warning'
      if: failure()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚ö†Ô∏è Security Issues Found",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ö†Ô∏è Security Issues Found*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Check:* npm audit"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Stage 3: Run Tests
  test:
    name: 'Run Tests'
    runs-on: ubuntu-latest
    needs: [lint, security]
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: attendance_app
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4
    
    - name: 'Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: 'Install Dependencies'
      run: npm ci
    
    - name: 'Run Tests'
      run: npm test
      continue-on-error: true
      env:
        DB_HOST: localhost
        DB_USER: root
        DB_PASSWORD: password
        DB_NAME: attendance_app
    
    - name: 'Notify Slack - Tests Passed'
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "üß™ Tests Passed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üß™ Tests Passed*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: 'Notify Slack - Tests Failed'
      if: failure()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚ùå Tests Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ùå Tests Failed*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Logs:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Stage 4: Build & Push Docker Image
  build:
    name: 'Build & Push Docker Image'
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4
    
    - name: 'Set up Docker Buildx'
      uses: docker/setup-buildx-action@v3
    
    - name: 'Log in to Docker Hub'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: 'Extract Metadata'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: 'Build and Push Docker Image'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: 'Notify Slack - Build Success'
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "üê≥ Docker Image Built & Pushed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üê≥ Docker Image Built & Pushed*\n*Image:* ${{ env.IMAGE_NAME }}\n*Tag:* ${{ github.sha }}\n*Repository:* ${{ github.repository }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: 'Notify Slack - Build Failed'
      if: failure()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚ùå Docker Build Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ùå Docker Build Failed*\n*Repository:* ${{ github.repository }}\n*Logs:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Stage 5: Deploy
  deploy:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4
    
    - name: 'Deploy Application'
      run: |
        echo "üöÄ Deploying to production..."
        echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "‚úÖ Deployment completed"
    
    - name: 'Notify Slack - Deploy Success'
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "üöÄ Deployment Successful",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üöÄ Deployment Successful*\n*Environment:* Production\n*Repository:* ${{ github.repository }}\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Deployed by:* ${{ github.actor }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: 'Notify Slack - Deploy Failed'
      if: failure()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚ùå Deployment Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ùå Deployment Failed*\n*Environment:* Production\n*Repository:* ${{ github.repository }}\n*Logs:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Stage 6: Release
  release:
    name: 'Create Release'
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 'Generate Version'
      id: version
      run: |
        VERSION=$(date +%Y.%m.%d)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release Version: $VERSION"
    
    - name: 'Create Release'
      continue-on-error: true
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        body: |
          ## Release v${{ steps.version.outputs.version }}
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Author: ${{ github.actor }}
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 'Fallback Release with GitHub CLI'
      continue-on-error: true
      run: |
        git tag v${{ steps.version.outputs.version }} || true
        gh release create v${{ steps.version.outputs.version }} \
          --title "Release v${{ steps.version.outputs.version }}" \
          --notes "## Release v${{ steps.version.outputs.version }}" \
          -R ${{ github.repository }} || echo "Release creation skipped (may already exist)"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 'Notify Slack - Release Success'
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "üì¶ Release Published",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üì¶ Release Published*\n*Version:* v${{ steps.version.outputs.version }}\n*Repository:* ${{ github.repository }}\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: 'Notify Slack - Release Failed'
      if: failure()
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚ùå Release Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ùå Release Failed*\n*Repository:* ${{ github.repository }}\n*Logs:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Final: Pipeline Summary
  summary:
    name: 'Pipeline Summary'
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, deploy, release]
    if: always()
    
    steps:
    - name: 'Pipeline Summary'
      run: |
        echo "=== CI/CD Pipeline Summary ==="
        echo "Lint: ${{ needs.lint.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "Deploy: ${{ needs.deploy.result }}"
        echo "Release: ${{ needs.release.result }}"

    - name: 'Notify Slack - Pipeline Complete'
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "‚úÖ Pipeline Complete",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚úÖ Pipeline Complete*\n*Lint:* ${{ needs.lint.result }}\n*Security:* ${{ needs.security.result }}\n*Tests:* ${{ needs.test.result }}\n*Build:* ${{ needs.build.result }}\n*Deploy:* ${{ needs.deploy.result }}\n*Release:* ${{ needs.release.result }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
